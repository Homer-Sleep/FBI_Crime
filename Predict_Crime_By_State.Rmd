---
title: "FBI_Crime"
author: "Dave"
date: "3/16/2022"
output: html_document
---

## Project discription
This project will examine the FBI violent crime data from 2009-2019. The data is organized by state, region, and incident rate (e.g., Murder, Rape, Aggravated assault) per 100,000 people. The first step is to pull the crime data from the FBI website for each year. These column names have changed over the years, so these will have to be unified. The next step will look at the Bureau of Labor Statistics data (e.g., unemployment, inflation, wages). I will need to pick variables to merge into the FBI crime data. Once this is merged and cleaned we can begin the machine learning stage. 

First, I will use some unsupervised tools to look over the data. I intend to use a PCA to examine how variables of crime and economics load onto common components. I also intend to do a hierarchical cluster analysis to see if any interesting subgroups emerge. 

The next step is to start the supervised stage. I will examine how population and economic factors predict crime by state and region. If any subgroups or components of interest are discovered in the unsupervised stage they will be incorporated. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(plyr)
library(papeR)
library(dplyr)
library(ggplot2)
library(knitr)
library(kableExtra)
library(tidyr)
library(readxl)
library(data.table)
# library(stringi)
# library(foreign)
# library(multcomp)
# library(broom)
# library(nlme)
library(tidyverse)
# library(stargazer)
# library(reshape2)
# library(rmarkdown)
# library(psych)
library(RColorBrewer)
# library(minpack.lm)
# library(numDeriv)
# # library(mosaic)
# library(pracma)
# library(formattable)
# library(lme4)
# library(sjPlot)
# library(emmeans)
# library(Cairo) # Cleans up plot Alias CairoWIN() use ggsave "cairo-png"
knitr::opts_chunk$set(dev.args = list(png = list(type = "cairo")))

```



### Pull data sets from FBI:
```{r}

# each xls sheet has that year and the previous year. Download 2010, 2012, 2014, 2016. 2018, 2019
urls = c('https://ucr.fbi.gov/crime-in-the-u.s/2010/crime-in-the-u.s.-2010/tables/10tbl04.xls/output.xls',
         'https://ucr.fbi.gov/crime-in-the-u.s/2012/crime-in-the-u.s.-2012/tables/4tabledatadecoverviewpdf/table_4_crime_in_the_united_states_by_region_geographic_division_and_state_2011-2012.xls/output.xls',
         'https://ucr.fbi.gov/crime-in-the-u.s/2014/crime-in-the-u.s.-2014/tables/table-4/table_4_crime_in_the_united_states_by_region_geographic_division_and_state_2013-2014.xls/output.xls',
         'https://ucr.fbi.gov/crime-in-the-u.s/2016/crime-in-the-u.s.-2016/tables/table-2/table-2.xls/output.xls',
         'https://ucr.fbi.gov/crime-in-the-u.s/2018/crime-in-the-u.s.-2018/tables/table-4/table-4.xls/output.xls',
         'https://ucr.fbi.gov/crime-in-the-u.s/2019/crime-in-the-u.s.-2019/tables/table-4/table-4.xls/output.xls')
Crime.datasets = c('2009_2010.xls', '2011_2012.xls', '2013_2014.xls', '2015_2016.xls', '2017_2018.xls', '2019.xls') 

 for (i in seq_along(urls)) {
   if(!file.exists(Crime.datasets[i])){
   download.file(urls[i], Crime.datasets[i], mode = 'wb') # download xls from FBI website
   }
  }
```

### Merge Data across years:
```{r}
 for (i in seq_along(Crime.datasets)) {

  Crime.raw = NULL
  Crime.raw = data.table(read_excel(Crime.datasets[i], skip = 3)) # read into data.table
  # remove empty columns
  Crime.raw = Crime.raw[,which(unlist(lapply(Crime.raw, function(x)!all(is.na(x))))),with=F]
  
  # rename cols to be the same across data sets
  pop.fix = startsWith(colnames(Crime.raw), prefix = 'Pop')
  setnames(Crime.raw, colnames(Crime.raw[,..pop.fix]), 'Population')
  
  pop.fix = startsWith(colnames(Crime.raw), prefix = 'Murder')
  setnames(Crime.raw, colnames(Crime.raw[,..pop.fix]), 'Murder')
  
  pop.fix = startsWith(colnames(Crime.raw), prefix = 'Violent')
  setnames(Crime.raw, colnames(Crime.raw[,..pop.fix]), 'Violent.Crime')
  
  pop.fix = endsWith(colnames(Crime.raw), suffix = '(revised definition)4')
  if(sum(pop.fix) == 1){setnames(Crime.raw, colnames(Crime.raw[,..pop.fix]), 'Revised_Rape')}
  
  pop.fix = endsWith(colnames(Crime.raw), suffix = '(legacy definition)5')
  if(sum(pop.fix) == 1){setnames(Crime.raw, colnames(Crime.raw[,..pop.fix]), 'Rape')}
    
  pop.fix = startsWith(colnames(Crime.raw), prefix = 'Forcible')
  if(sum(pop.fix) == 1){setnames(Crime.raw, colnames(Crime.raw[,..pop.fix]), 'Rape')}
  
  
  #rename columns leading with '..#'
  # find col with Name
  col.names = colnames(Crime.raw)
  for (col.i in seq_along(col.names)) {
    if (startsWith(col.names[col.i], prefix = '..')){ # rename cols that start with '..' to _Per100k'
      col.names[col.i] = paste0(col.names[col.i -1], '_Per100k')
      }
    }
  setnames(Crime.raw, names(Crime.raw),  col.names) # rename 
  
  # remove extra cols if any
  rm.col=  !endsWith(colnames(Crime.raw), suffix = '_Per100k_Per100k') # extra cols will have extra per100k
  Crime.raw = Crime.raw[,..rm.col]# remove cols
  
  #remove cols of raw numbers, leave per100k for comparisons across states
  rm.col = endsWith(colnames(Crime.raw), suffix = '_Per100k')
  rm.col[1:3] = TRUE # keep first 3 rows of Area, year and population 
  Crime.raw = Crime.raw[,..rm.col]
  # Remove numbers  and comma from Area
  Crime.raw$Area = gsub('[0-9]', '', Crime.raw$Area)
  Crime.raw$Area = gsub(',', '', Crime.raw$Area)

  # edit rows:
  Crime.raw = Crime.raw[Year != 'Percent change']# remove percent change rows
  
  # If Area name is NA, rename it to row above
  for (ii in 1:Crime.raw[,.N]) {
      if (is.na(Crime.raw[ii, 1])){
      Crime.raw[ii, 1] = Crime.raw[ii-1, 1]
    }
  }
    two.years = unique(Crime.raw$Year)
  if (two.years[1] == '2018'){
    Crime.raw = Crime.raw[Year == '2019']
  }    

  # change to numeric
  Crime.raw[,2:ncol(Crime.raw)] = as.data.table(sapply(Crime.raw[,2:ncol(Crime.raw)], as.numeric))
  
  # Round each col,
    Crime.raw %>% mutate_if(is.numeric, ~round(., digit = 2))  
  # Make List by year
  # Year.crime[[two.years[1]]] = Crime.raw[Year == two.years[1]]
  # Year.crime[[two.years[2]]] = Crime.raw[Year == two.years[2]]
  
  if (i ==1){
    Crime = Crime.raw
  }else{
    if(sum(colnames(Crime.raw) == 'Rape_Per100k') == 0){
       Crime = merge.data.table(Crime, Crime.raw, by = colnames(Crime.raw), all = TRUE)
    }else{
    Crime = merge.data.table(Crime, Crime.raw, by = colnames(Crime), all = TRUE)
    setdiff (colnames(Crime), colnames(Crime.raw))
    setdiff (colnames(Crime.raw), colnames(Crime))
    }
  }
}
  
```
 
